<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π —Ç–∞–π–º–µ—Ä</title>
	
	<link rel="icon" href="icons/favicon.svg" type="image/svg+xml">
	
	<!-- Apple Touch Icons (—Ä–∞–∑–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤) -->
	<link rel="apple-touch-icon" href="icons/apple-touch-icon-180x180.png" sizes="180x180">
	<link rel="apple-touch-icon" href="icons/apple-touch-icon-167x167.png" sizes="167x167">
	<link rel="apple-touch-icon" href="icons/apple-touch-icon-152x152.png" sizes="152x152">
	<link rel="apple-touch-icon" href="icons/apple-touch-icon-120x120.png" sizes="120x120">
	
	<!-- –ú–∞–Ω–∏—Ñ–µ—Å—Ç –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
	<link rel="manifest" href="manifest.json">
	
	<!-- –®—Ä–∏—Ñ—Ç—ã -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
	<style>
		:root {
			--bg-color: #000;
			--text-color: #fff;
			--primary-color: #71FEAB;
			--red900: #7A0919;
			--red600: #DB3323;
			--red500: #FF5230;
			--red100: #FFCCAC;
			--green600: #30DA98;
			--green400: #71FEAB;
			--green900: #0C7970;
			--green1000: #042d29;
			--border-color: rgba(255,255,255,.2);
			--border-red: var(--red900);
			--border-green: var(--green900);
			--grey40: rgba(255,255,255,.4);
			--radius-outer: 24px;
			--gap: 4vw;
			--gap-mid: 2vw;           
		}

		html {
			height: 100%;
		}

		body, button {
			font-family: "IBM Plex Sans", sans-serif;
		}

		body {
			font-family: "IBM Plex Sans", sans-serif;
			font-weight: 300;
			background-color: var(--bg-color);
			color: var(--text-color);
			display: flex;
			flex-direction: column;
			padding: 4vw;
		}
		
		label {
			font-size: 32px;
			line-height: 40px;
			display: block;
			width: 100%;
			margin-top: 24px;
		}

		input {
			width: 100%;
			font-family: "IBM Plex Sans", serif;
			font-weight: 100;
			padding: 0 0 8px 0;
			height:152px;
			margin: 16px 0;
			box-sizing: border-box;
			border: 1px solid var(--border-color);
			border-radius: var(--radius-outer);
			font-size: 144px;
			text-align: center;
			background-color: transparent;
		}

		input::placeholder {
			color: var(--grey40);
		}

		button {
			padding: 16px;
			background: var(--primary-color);
			color: var(--green900);
			border: none;
			border-radius: var(--radius-outer);
			cursor: pointer;
			transition: opacity 0.3s;
			font-size: 32px;
			line-height: 40px;
			font-weight: 500;
			width: fit-content;
		}

		button:active {
			opacity: 0.8;
		}

		label.green500 {
			color: var(--green600);
		}

		label.red600, h4 {
			color: var(--red600);
		}

		input#totalTime {
			color: var(--green400);
			border-color: var(--border-green);
		}

		input#totalTime:focus {
			outline: 4px double var(--green400);
		}

		input#totalTime::placeholder {
			color: var(--green900);
		}

		input#numTracks {
			color: var(--red600);
			border-color: var(--border-red);
		}

		input#numTracks:focus {
			outline: 4px double var(--red500);
		}

		input#numTracks::placeholder {
			color: var(--red900);
		}

		h4 {
			font-size: 4vw;
			line-height: 8vw;
			font-weight: 400;
			margin: 0;
		}

		.status-bar {
			display: flex;
			flex-direction: row;
			gap: var(--gap);
			align-items: center;
		}

		#trackDuration {
			color: var(--green600);
		}

		.input-group {
			margin-bottom: 16px;
		}

		.curTrack {
			font-size: 48px;
		}

		.trkCount {
			font-size: 20px;
		}

		.blink {
			animation: blink .3s ease-in-out infinite;
			color: var(--red500) !important;
		}

		.trackTimerFrame {
			display: flex;
			flex-direction: column;
			width: 100%;
			gap: var(--gap);
		}

		.perfTimerFrame {
			display: flex;
			flex-direction: column;
			width: 100%;
			gap: var(--gap);
		}

		.row {
			display: flex;
			flex-direction: row;
		}

		.column {
			width: 100%;
		}

		.timer-container {
			margin: 0 0 24px 0;
			display: flex;
			flex-direction: column;
			gap: var(--gap);
		}
		
		/*–¢–∞–π–º–µ—Ä—ã*/
		.timer {
			margin: 16px 0;
			letter-spacing: 2px;
		}

		.timer.main {
			font-size: 32vw;
			line-height: 36vw;
			font-weight: 100;
			color: var(--green400);
		}

		.timer.secondary {
			font-size: 12vw;
			line-height: 16vw;
			font-weight: 300;
			color: var(--grey40);
		}
		
		/*–ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä—ã*/
		.progress-container {
			height: 48px;
			background: #333;
			border-radius: var(--radius-outer);
			overflow: hidden;
			position: relative;
		}

		.progress-container.total-pb {
			height: 24px;
		}

		.progress-bar {
			height: 100%;
		}

		#trackProgress {
			background: var(--green400);
		}

		#currentTrack {
			margin: 16px 0;
			color: var(--green400);
		}

		/*–ö–Ω–æ–ø–∫–∏*/
		#resetBtn {
			background: var(--red500);
			color: var(--red100);
			margin: 0 0 32px 0;
		}

		#nextTrackBtn {
			background-color: var(--green900);
			color: var(--green400);
		}

		#nextTrackBtn:disabled {
			opacity: .2;
			background-color: var(--green900);
			color: var(--green400);
		}

		/*–°—Ç–∞—Ç—É—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π*/
		#wakeLockStatus {
			font-size: 24px;
			color: var(--green400);
		}

		/* –°—Ç–∏–ª–∏ –¥–ª—è –±—É—Ä–≥–µ—Ä-–º–µ–Ω—é */
		.burger-menu {
			position: fixed;
			top: 4vw;
			right: 8vw;
			z-index: 1000;
		}

		.burger-icon {
			cursor: pointer;
			font-size: 32px;
			color: var(--red500);
			padding: 10px;
			transition: transform 0.3s;
		}

		.menu-content {
			display: none;
			position: absolute;
			right: 0;
			top: 100%;
			background: var(--surface-200);
			border-radius: 8px;
			padding: 16px;
			min-width: 180px;
		}

		.menu-content.show {
			display: block;
			animation: slideDown 0.3s ease;
		}

		#hiddenResetBtn {
			background: var(--red500);
			border: 1px solid var(--border-red);
			color: var(--red100);
			padding: 12px;
			width: 100%;
			font-size: 16px;
			margin: 0;
			transition: all 0.3s;
		}

		#hiddenResetBtn:active {
			background: var(--error-100);
			color: var(--text-on-primary);
		}
		
		/* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º –º–µ–Ω—é */
		.menu-backdrop {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0,0,0,0.5);
			display: none;
			z-index: 999;
		}

		/*–ß–∏–ø—ã –ø—Ä–µ—Å–µ—Ç–æ–≤*/
		.shortcuts {
			display: flex;
			flex-direction: row;
			align-items: center;
			justify-content: center;
			gap: 16px;
		}

		.chip {
			font-size: 20px;
			line-height: 24px;
			font-weight: 400;
			padding: 8px 16px;
			background-color: var(--green1000);
			color: var(--green400);
			border-radius: var(--radius-outer);
		}

		.chip.active {
			background: var(--green600);
			color: var(--green900);
		}

		.spacer {
			height: 24px;
		}

		/*–ê–Ω–∏–º–∞—Ü–∏–∏*/
		
		/*–ú–∏–≥–∞–Ω–∏–µ*/
		@keyframes blink {
			0%, 100% { opacity: 1; }
			50% { opacity: 0.3; }
		}

		/*–ú–µ–Ω—é*/
		@keyframes slideDown {
			from {
				opacity: 0;
				transform: translateY(-8px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}


		@media (orientation: landscape) {
  			body {
    			flex-direction: row;
    			padding: 0;
    			align-items: center;
				justify-content: center;
				height: 100%;
  			}

  			.row {
				flex-direction: column;
			}

			.trackTimerFrame {
				width: 61vw;
			}

			.perfTimerFrame {
				width: 28vw;
				gap: var(--gap-mid);
			}

			.timer {
				margin: 0;
			}

			.timer.main {
			    font-size: 20vw;
			    line-height: 20vw;
			    display: inline-block;
			    width: 100%;
			    text-align: center;
			}

			.burger-menu {
				top: 4vw;
				right: 4vw;
			}

			.timer.secondary {
			    font-size: 6vw;
			    line-height: 8vw;
			}

			h4 {
				font-size: 2vw;
    			line-height: 2vw;
			}
			
			.timer-container {
				flex-direction: row;
				gap: var(--gap);
			}

			#nextTrackBtn, .total-pb.total-pb {
				height: 100%;
			}

			.spacer {
				display: none;
			}

		}

	</style>
		</head>
		<body>
		<!-- –ë—É—Ä–≥–µ—Ä –º–µ–Ω—é -->
		<div class="burger-menu">
			<div class="burger-icon" onclick="toggleMenu()">‚ò∞</div>
			<div class="menu-content">
				<button id="hiddenResetBtn" onclick="handleReset()">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
			</div>
		</div>
		<!-- –§–æ—Ä–º–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ -->
		<form id="configForm">
			<div class="input-group">
				<label class="green500">–í—Ä–µ–º—è (–º–∏–Ω)</label>
				<input type="number" id="totalTime" placeholder="0" pattern="[0-9]*" inputmode="numeric" required>
				<div class="shortcuts">
					<div class="chip" data-minutes="30">30</div>
					<div class="chip" data-minutes="60">60</div>
					<div class="chip" data-minutes="90">90</div>
					<div class="chip" data-minutes="120">120</div>
				</div>
			</div>
			<div class="input-group">
				<label class="red600">–¢—Ä–µ–∫–æ–≤</label>
				<input type="number" id="numTracks" placeholder="0" pattern="[0-9]*" inputmode="numeric" required>
			</div>
			<button type="submit">–°—Ç–∞—Ä—Ç</button>
		</form>
		<!-- –¢–∞–π–º–µ—Ä -->
		<div id="timers" class="timers" style="display: none;">
			<div class="timer-container">
				

				<div class="trackTimerFrame">
					<h4 class="status-bar">
						<span class="curTrack" id="currentTrack"></span>/<span class="trkCount" id="trackCount"></span> <span id="trackDuration"></span><span id="wakeLockStatus"></span>
					</h4>
					<div><span id="trackTimer" class="timer main"></span></div>
					<div class="progress-container">
						<div id="trackProgress" class="progress-bar"></div>
					</div>
				</div>

				
				<div class="perfTimerFrame">
					<div class="row">
						<div class="column">
							<h4>–ü—Ä–æ—à–ª–æ</h4>
							<div><span id="elapsedTimer" class="timer secondary"></span></div>
						</div>
						<div class="column">
							<h4>–û—Å—Ç–∞–ª–æ—Å—å</h4>
							<div><span id="remainingTimer" class="timer secondary"></span></div>
						</div>
					</div>
					<div class="progress-container total-pb">
						<div id="totalProgress" class="progress-bar" style="background: var(--red500);"></div>
					</div>
					<div class="spacer"></div>
					<button id="nextTrackBtn" onclick="nextTrack()">–ü—Ä–æ–ø—É—Å–∫</button>
				</div>

			</div>
		</div>
		<script>

		// –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Service Worker
		if ('serviceWorker' in navigator) {
			window.addEventListener('load', async () => {
				try {
					const registration = await navigator.serviceWorker.register('/sw.js');
					console.log('ServiceWorker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
				} catch (err) {
					console.log('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ServiceWorker:', err);
				}
			});
		}

		// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
		navigator.serviceWorker.addEventListener('controllerchange', () => {
			window.location.reload();
		});

		let wakeLock = null;
		let intervalId;
		let state = {
			startTime: null,         // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
			totalDuration: null,     // –û–±—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
			originalTracks: null,    // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–∫–æ–≤
			currentTrack: 1,         // –¢–µ–∫—É—â–∏–π —Ç—Ä–µ–∫
			spentTimes: []           // –ú–∞—Å—Å–∏–≤ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ —Ç—Ä–µ–∫–∞–º
		};
		let isMenuOpen = false;

		function toggleMenu() {
			const menu = document.querySelector('.menu-content');
			let backdrop = document.querySelector('.menu-backdrop');
			
			isMenuOpen = !isMenuOpen;
			
			if(isMenuOpen) {
				menu.classList.add('show');
				if(!backdrop) {
					backdrop = document.createElement('div');
					backdrop.className = 'menu-backdrop';
					backdrop.onclick = toggleMenu;
					document.body.appendChild(backdrop);
				}
				backdrop.style.display = 'block';
			} else {
				menu.classList.remove('show');
				if(backdrop) {
					backdrop.style.display = 'none';
				}
			}
		}

		// –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —ç–∫—Ä–∞–Ω–∞
		async function requestWakeLock() {
			try {
				if ('wakeLock' in navigator) {
					wakeLock = await navigator.wakeLock.request('screen');
					document.getElementById('wakeLockStatus').textContent = 'üí°';
				}
			} catch (err) {
				console.error('–û—à–∏–±–∫–∞ Wake Lock:', err);
			}
		}

		function releaseWakeLock() {
			if (wakeLock !== null && !wakeLock.released) {
				wakeLock.release();
				wakeLock = null;
			}
		}

		// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
		function formatTime(ms) {
			const totalMs = Math.max(0, ms);
			const totalSeconds = Math.floor(totalMs / 1000);
			const mins = Math.floor(totalSeconds / 60);
			const secs = totalSeconds % 60;
			return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
		}

		// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
		function saveState() {
			localStorage.setItem('timerState', JSON.stringify(state));
		}

		// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
		function restoreState() {
			const savedState = localStorage.getItem('timerState');
			if (!savedState) return;

			try {
				const parsed = JSON.parse(savedState);
				const now = Date.now();
				
				// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
				if (!parsed.startTime || !parsed.totalDuration || !parsed.originalTracks) {
					localStorage.removeItem('timerState');
					return;
				}

				// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –ª–∏ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ
				const timePassed = now - parsed.startTime;
				if (timePassed >= parsed.totalDuration) {
					localStorage.removeItem('timerState');
					return;
				}

				// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
				state = {
					startTime: parsed.startTime,
					totalDuration: parsed.totalDuration,
					originalTracks: parsed.originalTracks,
					currentTrack: parsed.currentTrack,
					spentTimes: parsed.spentTimes
				};

				// –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞
				const totalSpent = state.spentTimes.reduce((a, b) => a + b, 0);
				const trackDuration = (state.totalDuration - totalSpent) / 
									(state.originalTracks - state.currentTrack + 1);
				const currentTrackElapsed = timePassed - totalSpent;

				// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤
				while (currentTrackElapsed > trackDuration && 
					  state.currentTrack < state.originalTracks) {
					state.spentTimes.push(trackDuration);
					state.currentTrack++;
					totalSpent += trackDuration;
					trackDuration = (state.totalDuration - totalSpent) / 
								  (state.originalTracks - state.currentTrack + 1);
				}

				saveState(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
			} catch (e) {
				console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:', e);
				localStorage.removeItem('timerState');
			}
		}

		// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–ø—É—Å–∫"
		function nextTrack() {
			const now = Date.now();
			const totalSpent = state.spentTimes.reduce((a, b) => a + b, 0);
			const currentTrackTime = now - state.startTime - totalSpent;

			if(currentTrackTime <= 0) return;
			
			state.spentTimes.push(currentTrackTime);
			state.currentTrack++;
			
			if(state.currentTrack > state.originalTracks) {
				finishPerformance();
				return;
			}
			
			saveState();
			updateTimers();
		}

		// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–æ–≤
		function updateTimers() {
			const now = Date.now();
			const totalElapsed = now - state.startTime;
			
			if(totalElapsed >= state.totalDuration) {
				finishPerformance();
				return;
			}

			// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∫–Ω–æ–ø–∫–∏
			const nextTrackBtn = document.getElementById('nextTrackBtn');
			const isLastTrack = state.currentTrack === state.originalTracks;
			nextTrackBtn.disabled = isLastTrack;
			const totalSpent = state.spentTimes.reduce((a, b) => a + b, 0);
			const remainingTracks = state.originalTracks - state.currentTrack + 1;
			const trackDuration = (state.totalDuration - totalSpent) / remainingTracks;
			const trackElapsed = totalElapsed - totalSpent;
			let trackRemaining = trackDuration - trackElapsed;

			// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –ø—Ä–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
			if(trackRemaining <= 0 && remainingTracks > 1) {
				state.spentTimes.push(trackDuration);
				state.currentTrack++;
				saveState();
				return updateTimers(); // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º
			}

			// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
			document.getElementById('currentTrack').textContent = state.currentTrack;
			document.getElementById('trackCount').textContent = `${state.originalTracks}`;
			document.getElementById('trackTimer').textContent = formatTime(trackRemaining);
			document.getElementById('elapsedTimer').textContent = formatTime(totalElapsed);
			document.getElementById('remainingTimer').textContent = formatTime(state.totalDuration - totalElapsed);
			document.getElementById('trackDuration').textContent = formatTime(trackDuration);

			// –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã
			const totalProgress = (totalElapsed / state.totalDuration) * 100;
			const trackProgress = (trackElapsed / trackDuration) * 100;
			
			document.getElementById('totalProgress').style.width = `${totalProgress}%`;
			document.getElementById('trackProgress').style.width = `${trackProgress}%`;

			// –ú–∏–≥–∞–Ω–∏–µ
			const trackTimerElement = document.getElementById('trackTimer');
			const trackProgressBar = document.getElementById('trackProgress');
			if (trackRemaining <= 30000) { // 30 —Å–µ–∫—É–Ω–¥
				trackTimerElement.classList.add('blink');
				trackProgressBar.classList.add('blink');
			} else {
				trackTimerElement.classList.remove('blink');
				trackProgressBar.classList.remove('blink');
			}
		}

		// –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è
		function finishPerformance() {
			clearInterval(intervalId);
			alert('–í—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!');
			resetApp();
		}

		// –°–±—Ä–æ—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
		function resetApp() {
			clearInterval(intervalId);
			releaseWakeLock();
			localStorage.removeItem('timerState');
			state = {
				startTime: null,
				totalDuration: null,
				originalTracks: null,
				currentTrack: 1,
				spentTimes: []
			};
			document.getElementById('timers').style.display = 'none';
			document.getElementById('configForm').style.display = 'block';
			document.getElementById('nextTrackBtn').disabled = false;
		}

		function handleReset() {
			toggleMenu(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
			if(confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Ç–∞–π–º–µ—Ä? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')) {
				resetApp();
			}
		}

		// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
		document.getElementById('configForm').addEventListener('submit', (e) => {
			e.preventDefault();
			
			const totalMinutes = parseInt(document.getElementById('totalTime').value);
			const numTracks = parseInt(document.getElementById('numTracks').value);
			
			if(totalMinutes < 1 || numTracks < 1) {
				alert('–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –±–æ–ª—å—à–µ –Ω—É–ª—è!');
				return;
			}

			state = {
				startTime: Date.now(),
				totalDuration: totalMinutes * 60 * 1000,
				originalTracks: numTracks,
				currentTrack: 1,
				spentTimes: []
			};
			
			saveState();
			requestWakeLock();
			document.getElementById('configForm').style.display = 'none';
			document.getElementById('timers').style.display = 'block';
			intervalId = setInterval(updateTimers, 100);
			updateTimers();
		});

		// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
		window.addEventListener('load', () => {
			restoreState();
			
			if (state.startTime) {
				const timePassed = Date.now() - state.startTime;
				if (timePassed < state.totalDuration) {
					document.getElementById('configForm').style.display = 'none';
					document.getElementById('timers').style.display = 'block';
					intervalId = setInterval(updateTimers, 100);
					requestWakeLock();
					updateTimers();
				} else {
					resetApp();
				}
			}
		});

		// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —á–∏–ø–æ–≤
		document.querySelectorAll('.chip').forEach(chip => {
			chip.addEventListener('click', function() {
				// –£–¥–∞–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö —á–∏–ø–æ–≤
				document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
				
				// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
				const minutes = this.dataset.minutes;
				document.getElementById('totalTime').value = minutes;
				
				// –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–º—É —á–∏–ø—É
				this.classList.add('active');
				
				// –¢—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ–±—ã—Ç–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤
				document.getElementById('totalTime').dispatchEvent(new Event('input'));
			});
		});

		// –°–±—Ä–æ—Å —á–∏–ø–æ–≤ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –≤–≤–æ–¥–µ
		document.getElementById('totalTime').addEventListener('input', function() {
			const chips = document.querySelectorAll('.chip');
			const currentValue = this.value;
			
			// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ —Å —á–∏–ø–æ–º
			const activeChip = Array.from(chips).find(chip => 
				chip.dataset.minutes === currentValue
			);
			
			if(!activeChip) {
				chips.forEach(chip => chip.classList.remove('active'));
			}
		});

		// Wake Lock –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
		document.addEventListener('visibilitychange', () => {
			if(document.visibilityState === 'visible') {
				requestWakeLock();
			}
		});

	</script>
</body>
</html>